import mysql.connector
import firebase_admin
from firebase_admin import credentials, firestore
import json
from decimal import Decimal
import datetime

def normalize_value(value):
    if isinstance(value, Decimal):
        # N·∫øu l√† s·ªë nguy√™n th√¨ √©p v·ªÅ int
        if value == value.to_integral_value():
            return int(value)
        # Ng∆∞·ª£c l·∫°i √©p v·ªÅ float
        return float(value)
    if isinstance(value, datetime.date) and not isinstance(value, datetime.datetime):
        return datetime.datetime.combine(value, datetime.time())  # convert date -> datetime
    if isinstance(value, datetime.datetime):
        return value  # Firestore s·∫Ω l∆∞u th√†nh Timestamp
    return value

def normalize_dict(d):
    return {k: normalize_value(v) for k, v in d.items()}

def default_serializer(o):
    if isinstance(o, (datetime.datetime, datetime.date)):
        return o.isoformat()  # convert datetime -> "YYYY-MM-DDTHH:MM:SS"
    if isinstance(o, Decimal):
        return float(o)       # ho·∫∑c str(o) n·∫øu mu·ªën gi·ªØ ch√≠nh x√°c tuy·ªát ƒë·ªëi
    raise TypeError(f"Object of type {o.__class__.__name__} is not JSON serializable")

# ======================
# C·∫•u h√¨nh MySQL
# ======================
mysql_config = {
    "host": "localhost",
    "user": "root",
    "password": "Qhuy204",
    "database": "computerstore"
}

# ======================
# K·∫øt n·ªëi Firebase
# ======================
cred = credentials.Certificate(r"D:\VSCode\DA3\serviceAccountKey.json")  # file json t·∫£i t·ª´ Firebase console
firebase_admin.initialize_app(cred)
db = firestore.client()

# ======================
# H√†m export & import
# ======================
def export_and_import():
    conn = mysql.connector.connect(**mysql_config)
    cursor = conn.cursor(dictionary=True)

    # l·∫•y danh s√°ch b·∫£ng
    cursor.execute("SHOW FULL TABLES WHERE Table_type = 'BASE TABLE'")
    tables = [row[f"Tables_in_{mysql_config['database']}"] for row in cursor.fetchall()]

    total_docs = 0

    for table in tables:
        print(f"\nüì§ ƒêang x·ª≠ l√Ω b·∫£ng: {table}")
        cursor.execute(f"SELECT * FROM {table}")
        rows = cursor.fetchall()

        # Export ra file JSON (backup t√πy ch·ªçn)
        with open(f"{table}.json", "w", encoding="utf-8") as f:
            json.dump(rows, f, ensure_ascii=False, indent=2, default=default_serializer)

        # Import v√†o Firestore
        for row in rows:
            # N·∫øu c√≥ c·ªôt id/xxx_id th√¨ d√πng l√†m docId
            doc_id = None
            for key in row.keys():
                if key.lower().endswith("id"):
                    doc_id = str(row[key])
                    break

            if doc_id:
                db.collection(table).document(doc_id).set(normalize_dict(row))

            else:
                db.collection(table).add(row)

        print(f"‚úÖ ƒê√£ import {len(rows)} d√≤ng t·ª´ b·∫£ng {table} v√†o Firestore")
        total_docs += len(rows)

    cursor.close()
    conn.close()

    print(f"\nüéâ Ho√†n t·∫•t chuy·ªÉn {len(tables)} b·∫£ng, t·ªïng c·ªông {total_docs} d√≤ng MySQL ‚Üí Firestore")



# ======================
# Main
# ======================
if __name__ == "__main__":
    export_and_import()
